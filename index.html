<!DOCTYPE html>
<html>
  <style>
    table {
        width:100%;
    }
    table, th, td {
        border: 1px solid #000000;
        border-collapse: collapse;
    }
    th, td {
        padding: 5px;
        text-align: left;
    }
    table tr:nth-child(even) {
        background-color: #eeeeee;
    }
    table tr:nth-child(odd) {
        background-color:#ffffff;
    }
    table th {
        background-color: #777777;
        color: #ffffff;
    }
  </style>

  <head>
    <title>Jupyter Workspaces</title>
  </head>

  <body>
    <h3>Welcome to the jupyter workspace manager</h3>
    <h3>Current workspaces</h3>
    <select id="jupyter-instance" name="instance" onchange="addLinks(this)">
      <option value="" selected disabled hidden>Choose here</option>
      {{ range $value := .Instances }}
      <option value={{  $value  }}>{{ $value }}</option>
      {{ end }}
    </select>
    <table id="workspace-table">
      <tr>
        <th>Name</th>
        <th>Working Dir</th>
        <th>Num Open Notebooks</th>
      </tr>
      {{ range $idx, $value := .TableData }}
      <tr>
        <td name="instanceName">{{ $value.ID }}</td>
        <td>{{ $value.WorkingDir }}</td>
        <td>{{ $value.NumOpenNb }}</td>
      </tr>
      {{ end }}
    </table>

    <script>

      var SELECTED = [];
      addRowClickActions()

      function selectRowClickAction() {
          var rowSelected = this.parentNode;

          // TODO: use a different differentiator for selected
          if (isRemoveMode()) {
              if (rowSelected.selected === true) {
                  rowSelected.selected = false;
                  rowSelected.style.backgroundColor = "";
                  SELECTED = SELECTED.filter(item => item !== rowSelected.cells.instanceName);
              } else {
                  rowSelected.selected = true;
                  rowSelected.style.backgroundColor = "red";
                  SELECTED.push(rowSelected.cells.instanceName.innerText);
              }
          }
      }

      function addRowClickActions() {
          var table = document.getElementById('workspace-table');
          var cells = table.getElementsByTagName('td');

          for (var i = 0; i < cells.length; i++) {
              cells[i].onclick = selectRowClickAction
          }
      }

      function isRemoveMode() {
          return document.getElementById("removeMode").checked;
      }

      function removeWorkspaces() {
          removeModeBox = document.getElementById("removeMode");
          if (removeModeBox.checked === true) {
              if (SELECTED.length) {
                  var removeWorkspaceUrl = new URL(document.URL + "/remove_workspace")
                  removeWorkspaceUrl.search = new URLSearchParams({
                      'workspaces': SELECTED.join(',')
                  }).toString();

                  var reqPromise = fetch(removeWorkspaceUrl).then(function (response) {
                      if (response.ok) {
                          return response.json();
                      }
                      return Promise.reject(response);
                  });

                  reqPromise.then(function (data) {
		      // TODO: check error from response, alert?
		      var removedWorkspaces = new Set(data.result);
		      var table = document.getElementById('workspace-table');
		      // delete from the bottom up, so that the table indices don't get messed up on deletion
		      // Also, do not traverse into the table header (hence the i > 1 condition)
		      for (var i = table.rows.length - 1; i > 1; i--) {
			  if (removedWorkspaces.has(table.rows[i].children.instanceName.textContent)) {
			      table.deleteRow(i)
			  }
		      }
                  }).catch(function (err) {
                      // console.warn('Workspace removal request failed: ', err);
                      alert('Workspace removal request failed: ' + err.message);
                  });
              }

              removeModeBox.checked = false;
              clearSelectionIfExiting(removeModeBox);
          }
      }

      function addLink(linkCell, baseURL) {
	  firstChild = linkCell.childNodes[0]
	  if (firstChild.nodeName == "A") {
              firstChild.href = "http://" + baseURL + "/lab/workspaces/" + firstChild.textContent;
	  } else {
              let link = document.createElement('a');
              let linkText = firstChild.nodeValue;
              link.href = "http://" + baseURL + "/lab/workspaces/" + linkText;
	      link.target = "_blank"; // open link in new tab

              link.appendChild(document.createTextNode(linkText));
              linkCell.replaceChild(link, firstChild);
	  }
      }

      function addLinks(selections) {
          let linkCells = document.getElementsByName("instanceName");
	  let baseUrl = selections[selections.selectedIndex].value
	  linkCells.forEach(c => addLink(c, baseUrl))
      }

      function clearSelectionIfExiting(removeCheckbox) {
          if (!removeCheckbox.checked) {
              var table = document.getElementById('workspace-table');
              var rows = table.getElementsByTagName('tr');
              for (var i = 0; i < rows.length; i++) {
                  if (rows[i].selected === true) {
                      rows[i].selected = false;
                      rows[i].style.backgroundColor = "";
                  }
              }
              SELECTED = [];
          }
      }

    </script>

    <input type="checkbox" id="removeMode" name="removeMode" onclick="clearSelectionIfExiting(this)">
    <label for="removeMode">Remove Mode</label>
    <button onclick="removeWorkspaces()">Remove Selected</button>
  <body>
</html>
